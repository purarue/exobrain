<!doctype html><html lang="en"><title>exobrain | click.Choice and type narrowing</title><meta charset="UTF-8"><meta name="viewport"content="width=device-width,initial-scale=1"><meta http-equiv="Cache-Control"content="no-cache, no-store, must-revalidate"><link rel="shortcut icon"href="/assets/img/logo.png"type="image/png"><meta http-equiv="Pragma"content="no-cache"><meta http-equiv="Expires"content="0"><meta property="ba:title"content="back to my website"><meta property="ba:url"content="https://sean.fish"><meta property="ba:color"content="#999"><link rel="stylesheet"href="/assets/style.css"><header class="nav-bar"><nav><a class="homelink"href="/">exobrain</a><div class="nav-right"><div class="nav-item"><a class="nav-link"href="/search">[search]</a></div><div class="nav-item"><a class="nav-link"href="/feed">[feed]</a></div><div class="nav-item"><a class="nav-link"href="/sitemap">[sitemap]</a></div><div class="nav-item"><a class="nav-link"href="https://sean.fish">back to my site</a></div></div></nav></header><main><div class="container"><div id="main-header"><div class="h1"id="main-title">click.Choice and type narrowing</div><div class="title-date">2023/10/25</div></div><p>I am a heavy <a href="https://github.com/pallets/click"><code>click</code></a> user, but the lack of typesafety from the click decorators to the types in the function signature often bites me when making changes.<p>For example, this does not type error:<div class="sourceCode"id="cb1"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb1-1"><a href="#cb1-1"aria-hidden="true"tabindex="-1"></a><span class="im">import</span> click</span>
<span id="cb1-2"><a href="#cb1-2"aria-hidden="true"tabindex="-1"></a></span>
<span id="cb1-3"><a href="#cb1-3"aria-hidden="true"tabindex="-1"></a><span class="at">@click.command</span>()</span>
<span id="cb1-4"><a href="#cb1-4"aria-hidden="true"tabindex="-1"></a><span class="at">@click.option</span>(<span class="st">&quot;--flag&quot;</span>, <span class="bu">type</span><span class="op">=</span><span class="bu">int</span>, default<span class="op">=</span><span class="va">None</span>)</span>
<span id="cb1-5"><a href="#cb1-5"aria-hidden="true"tabindex="-1"></a><span class="kw">def</span> export(flag: <span class="bu">int</span>) <span class="op">-&gt;</span> <span class="va">None</span>:</span>
<span id="cb1-6"><a href="#cb1-6"aria-hidden="true"tabindex="-1"></a>    <span class="bu">print</span>(flag <span class="op">+</span> <span class="dv">5</span>)</span></code></pre></div><p>The <code>type=int</code> is just there for <code>click</code> to parse the user input. If the user didn’t provide anything, it ends up throwing an error at runtime since it defaults to <code>None</code><pre><code>print(flag + 5)
          ~~~~~^~~
TypeError: unsupported operand type(s) for +: &#39;NoneType&#39; and &#39;int&#39;</code></pre><p>However, mypy won’t warn us about that:<p>There’s no real way to fix the type in this case - this is an example of how your types for untyped code will just be casted, mypy assumes you’re correct when you specify those.<p>I very often use <code>click.Choice</code> to describe an output format for a command and then <code>match</code> on the format. A very basic example:<div class="sourceCode"id="cb3"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb3-1"><a href="#cb3-1"aria-hidden="true"tabindex="-1"></a><span class="im">import</span> click</span>
<span id="cb3-2"><a href="#cb3-2"aria-hidden="true"tabindex="-1"></a></span>
<span id="cb3-3"><a href="#cb3-3"aria-hidden="true"tabindex="-1"></a></span>
<span id="cb3-4"><a href="#cb3-4"aria-hidden="true"tabindex="-1"></a><span class="at">@click.command</span>()</span>
<span id="cb3-5"><a href="#cb3-5"aria-hidden="true"tabindex="-1"></a><span class="at">@click.option</span>(<span class="st">&quot;-o&quot;</span>, <span class="st">&quot;--ouptut&quot;</span>, <span class="bu">type</span><span class="op">=</span>click.Choice([<span class="st">&quot;text&quot;</span>, <span class="st">&quot;json&quot;</span>]), default<span class="op">=</span><span class="st">&quot;text&quot;</span>)</span>
<span id="cb3-6"><a href="#cb3-6"aria-hidden="true"tabindex="-1"></a><span class="kw">def</span> main(output: <span class="bu">str</span>) <span class="op">-&gt;</span> <span class="va">None</span>:</span>
<span id="cb3-7"><a href="#cb3-7"aria-hidden="true"tabindex="-1"></a>    data <span class="op">=</span> <span class="st">&quot;data&quot;</span></span>
<span id="cb3-8"><a href="#cb3-8"aria-hidden="true"tabindex="-1"></a></span>
<span id="cb3-9"><a href="#cb3-9"aria-hidden="true"tabindex="-1"></a>    <span class="cf">match</span> output:</span>
<span id="cb3-10"><a href="#cb3-10"aria-hidden="true"tabindex="-1"></a>        <span class="cf">case</span> <span class="st">&quot;text&quot;</span>:</span>
<span id="cb3-11"><a href="#cb3-11"aria-hidden="true"tabindex="-1"></a>            <span class="bu">print</span>(data)</span>
<span id="cb3-12"><a href="#cb3-12"aria-hidden="true"tabindex="-1"></a>        <span class="cf">case</span> <span class="st">&quot;json&quot;</span>:</span>
<span id="cb3-13"><a href="#cb3-13"aria-hidden="true"tabindex="-1"></a>            <span class="bu">print</span>({<span class="st">&quot;data&quot;</span>: data})</span>
<span id="cb3-14"><a href="#cb3-14"aria-hidden="true"tabindex="-1"></a>        <span class="cf">case</span> _:</span>
<span id="cb3-15"><a href="#cb3-15"aria-hidden="true"tabindex="-1"></a>            <span class="cf">raise</span> <span class="pp">ValueError</span>(<span class="ss">f&quot;Unknown output format: </span><span class="sc">{</span>output<span class="sc">}</span><span class="ss">&quot;</span>)</span>
<span id="cb3-16"><a href="#cb3-16"aria-hidden="true"tabindex="-1"></a></span>
<span id="cb3-17"><a href="#cb3-17"aria-hidden="true"tabindex="-1"></a><span class="cf">if</span> <span class="va">__name__</span> <span class="op">==</span> <span class="st">&quot;__main__&quot;</span>:</span>
<span id="cb3-18"><a href="#cb3-18"aria-hidden="true"tabindex="-1"></a>    main()</span></code></pre></div><p>However, if I add another format to the <code>Choice</code>, it would just skip it, since it does not match <code>text</code> or <code>json</code>.<p>I did the obvious thing and added default case and raise an error, but that is a runtime error – I’ve sometimes forgot to implement one of the cases for <code>click.Choice</code><p>Because we typed <code>output</code> as a <code>str</code>, there are quite literally infinite possibilities for it. Instead, we can constrain it a bit more by using a <a href="https://docs.python.org/3/library/typing.html#typing.Literal"><code>typing.Literal</code></a>:<div class="sourceCode"id="cb4"><pre class="sourceCode diff"><code class="sourceCode diff"><span id="cb4-1"><a href="#cb4-1"aria-hidden="true"tabindex="-1"></a><span class="va">+import typing</span></span>
<span id="cb4-2"><a href="#cb4-2"aria-hidden="true"tabindex="-1"></a><span class="va">+</span></span>
<span id="cb4-3"><a href="#cb4-3"aria-hidden="true"tabindex="-1"></a> import click</span>
<span id="cb4-4"><a href="#cb4-4"aria-hidden="true"tabindex="-1"></a></span>
<span id="cb4-5"><a href="#cb4-5"aria-hidden="true"tabindex="-1"></a><span class="va">+OutputFormat = typing.Literal[&quot;text&quot;, &quot;json&quot;]</span></span>
<span id="cb4-6"><a href="#cb4-6"aria-hidden="true"tabindex="-1"></a><span class="va">+</span></span>
<span id="cb4-7"><a href="#cb4-7"aria-hidden="true"tabindex="-1"></a></span>
<span id="cb4-8"><a href="#cb4-8"aria-hidden="true"tabindex="-1"></a> @click.command()</span>
<span id="cb4-9"><a href="#cb4-9"aria-hidden="true"tabindex="-1"></a> @click.option(&quot;-o&quot;, &quot;--ouptut&quot;, type=click.Choice([&quot;text&quot;, &quot;json&quot;]), default=&quot;text&quot;)</span>
<span id="cb4-10"><a href="#cb4-10"aria-hidden="true"tabindex="-1"></a><span class="st">-def main(output: str) -&gt; None:</span></span>
<span id="cb4-11"><a href="#cb4-11"aria-hidden="true"tabindex="-1"></a><span class="va">+def main(output: OutputFormat) -&gt; None:</span></span>
<span id="cb4-12"><a href="#cb4-12"aria-hidden="true"tabindex="-1"></a>     data = &quot;data&quot;</span>
<span id="cb4-13"><a href="#cb4-13"aria-hidden="true"tabindex="-1"></a></span>
<span id="cb4-14"><a href="#cb4-14"aria-hidden="true"tabindex="-1"></a>     match output:</span></code></pre></div><p>You can get the arguments out of a <code>Literal</code> by using <code>typing.get_args</code>, so we could remove the duplication in the <code>@click.option</code>:<pre><code>@click.option(&quot;-o&quot;, &quot;--ouptut&quot;, type=click.Choice(typing.get_args(OutputFormat)), default=&quot;text&quot;)</code></pre><p>If you wanted to remove the hardcoded <code>"text"</code> from the default, you could also use <code>typing.get_args(OutputFormat)[0]</code> to index into the first item in the Literal to pull out <code>"text"</code>.<p>However, if we add another format (say <code>table</code>), it’s still just going to raise the <code>ValueError</code><p>In order to ‘narrow’ the type so that mypy can infer that we’re missing a <code>typing.Literal</code> case, we can use <code>typing.assert_never</code> instead, to tell <code>mypy</code> that the default case should never be called:<div class="sourceCode"id="cb6"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb6-1"><a href="#cb6-1"aria-hidden="true"tabindex="-1"></a><span class="im">import</span> sys</span>
<span id="cb6-2"><a href="#cb6-2"aria-hidden="true"tabindex="-1"></a><span class="im">from</span> typing <span class="im">import</span> Literal, get_args</span>
<span id="cb6-3"><a href="#cb6-3"aria-hidden="true"tabindex="-1"></a></span>
<span id="cb6-4"><a href="#cb6-4"aria-hidden="true"tabindex="-1"></a><span class="im">import</span> click</span>
<span id="cb6-5"><a href="#cb6-5"aria-hidden="true"tabindex="-1"></a></span>
<span id="cb6-6"><a href="#cb6-6"aria-hidden="true"tabindex="-1"></a><span class="co"># Never is a new feature, so try to import it from the typing_extensions</span></span>
<span id="cb6-7"><a href="#cb6-7"aria-hidden="true"tabindex="-1"></a><span class="co"># package if it&#39;s not available in the current version of Python.</span></span>
<span id="cb6-8"><a href="#cb6-8"aria-hidden="true"tabindex="-1"></a><span class="cf">if</span> sys.version_info <span class="op">&lt;</span> (<span class="dv">3</span>, <span class="dv">11</span>):</span>
<span id="cb6-9"><a href="#cb6-9"aria-hidden="true"tabindex="-1"></a>    <span class="im">from</span> typing_extensions <span class="im">import</span> assert_never</span>
<span id="cb6-10"><a href="#cb6-10"aria-hidden="true"tabindex="-1"></a><span class="cf">else</span>:</span>
<span id="cb6-11"><a href="#cb6-11"aria-hidden="true"tabindex="-1"></a>    <span class="im">from</span> typing <span class="im">import</span> assert_never</span>
<span id="cb6-12"><a href="#cb6-12"aria-hidden="true"tabindex="-1"></a></span>
<span id="cb6-13"><a href="#cb6-13"aria-hidden="true"tabindex="-1"></a></span>
<span id="cb6-14"><a href="#cb6-14"aria-hidden="true"tabindex="-1"></a>OutputFormat <span class="op">=</span> Literal[<span class="st">&quot;text&quot;</span>, <span class="st">&quot;json&quot;</span>]</span>
<span id="cb6-15"><a href="#cb6-15"aria-hidden="true"tabindex="-1"></a></span>
<span id="cb6-16"><a href="#cb6-16"aria-hidden="true"tabindex="-1"></a></span>
<span id="cb6-17"><a href="#cb6-17"aria-hidden="true"tabindex="-1"></a><span class="at">@click.command</span>()</span>
<span id="cb6-18"><a href="#cb6-18"aria-hidden="true"tabindex="-1"></a><span class="at">@click.option</span>(</span>
<span id="cb6-19"><a href="#cb6-19"aria-hidden="true"tabindex="-1"></a>    <span class="st">&quot;-o&quot;</span>, <span class="st">&quot;--ouptut&quot;</span>, <span class="bu">type</span><span class="op">=</span>click.Choice(get_args(OutputFormat)), default<span class="op">=</span><span class="st">&quot;text&quot;</span></span>
<span id="cb6-20"><a href="#cb6-20"aria-hidden="true"tabindex="-1"></a>)</span>
<span id="cb6-21"><a href="#cb6-21"aria-hidden="true"tabindex="-1"></a><span class="kw">def</span> main(output: OutputFormat) <span class="op">-&gt;</span> <span class="va">None</span>:</span>
<span id="cb6-22"><a href="#cb6-22"aria-hidden="true"tabindex="-1"></a>    data <span class="op">=</span> <span class="st">&quot;data&quot;</span></span>
<span id="cb6-23"><a href="#cb6-23"aria-hidden="true"tabindex="-1"></a></span>
<span id="cb6-24"><a href="#cb6-24"aria-hidden="true"tabindex="-1"></a>    <span class="cf">match</span> output:</span>
<span id="cb6-25"><a href="#cb6-25"aria-hidden="true"tabindex="-1"></a>        <span class="cf">case</span> <span class="st">&quot;text&quot;</span>:</span>
<span id="cb6-26"><a href="#cb6-26"aria-hidden="true"tabindex="-1"></a>            <span class="bu">print</span>(data)</span>
<span id="cb6-27"><a href="#cb6-27"aria-hidden="true"tabindex="-1"></a>        <span class="cf">case</span> <span class="st">&quot;json&quot;</span>:</span>
<span id="cb6-28"><a href="#cb6-28"aria-hidden="true"tabindex="-1"></a>            <span class="bu">print</span>({<span class="st">&quot;data&quot;</span>: data})</span>
<span id="cb6-29"><a href="#cb6-29"aria-hidden="true"tabindex="-1"></a>        <span class="cf">case</span> _:</span>
<span id="cb6-30"><a href="#cb6-30"aria-hidden="true"tabindex="-1"></a>            assert_never(output)</span>
<span id="cb6-31"><a href="#cb6-31"aria-hidden="true"tabindex="-1"></a></span>
<span id="cb6-32"><a href="#cb6-32"aria-hidden="true"tabindex="-1"></a></span>
<span id="cb6-33"><a href="#cb6-33"aria-hidden="true"tabindex="-1"></a><span class="cf">if</span> <span class="va">__name__</span> <span class="op">==</span> <span class="st">&quot;__main__&quot;</span>:</span>
<span id="cb6-34"><a href="#cb6-34"aria-hidden="true"tabindex="-1"></a>    main()</span></code></pre></div><p><code>assert_never</code> is itself a very simple function that looks like this:<div class="sourceCode"id="cb7"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb7-1"><a href="#cb7-1"aria-hidden="true"tabindex="-1"></a><span class="kw">def</span> assert_never(arg: Never) <span class="op">-&gt;</span> Never:</span>
<span id="cb7-2"><a href="#cb7-2"aria-hidden="true"tabindex="-1"></a>    <span class="cf">raise</span> <span class="pp">AssertionError</span>(<span class="ss">f&quot;Unhandled value: </span><span class="sc">{</span>arg<span class="sc">!r}</span><span class="ss">&quot;</span>)</span></code></pre></div><p>the <code>Never</code> type tells <code>mypy</code> that this is a ‘bottom type’, it has no members and should never be called.<p>Now, if we update the <code>OutputFormat</code> <code>Literal</code> and add <code>"table"</code>, it gets added to the <code>click.Choice</code> automatically because of <code>get_args</code>, and we get a warning from <code>mypy</code>!<div class="sourceCode"id="cb8"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb8-1"><a href="#cb8-1"aria-hidden="true"tabindex="-1"></a><span class="op">-</span>OutputFormat <span class="op">=</span> Literal[<span class="st">&quot;text&quot;</span>, <span class="st">&quot;json&quot;</span>]</span>
<span id="cb8-2"><a href="#cb8-2"aria-hidden="true"tabindex="-1"></a><span class="op">+</span>OutputFormat <span class="op">=</span> Literal[<span class="st">&quot;text&quot;</span>, <span class="st">&quot;json&quot;</span>, <span class="st">&quot;table&quot;</span>]</span></code></pre></div><pre><code>example.py:30: error: Argument 1 to &quot;assert_never&quot; has incompatible type &quot;Literal[&#39;table&#39;]&quot;; expected &quot;NoReturn&quot;  [arg-type]
Found 1 error in 1 file (checked 1 source file)</code></pre></div></main><footer><p><a href="https://creativecommons.org/licenses/by-sa/4.0/legalcode"id="copyright">© 2022 Sean Breckenridge. Licensed under Creative Commons Attribution-ShareAlike.</a><br><a href="https://github.com/seanbreckenridge/exobrain">Source Code</a></footer><script src="/assets/main.js"></script><script src="https://sean.fish/p/back-arrow-bundle.js"></script>