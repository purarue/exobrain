#!/usr/bin/env bash

THIS_DIR="$(realpath "$(dirname "${BASH_SOURCE[0]}")")"
cd "${THIS_DIR}" || exit $?

commit_message="$*"
if [[ -z "$commit_message" ]]; then
	commit_message="$(gum input --prompt='commit message> ')"
fi

if [[ -z "$commit_message" ]]; then
	echo "No commit message provided" >&2
	exit 1
fi

on_laptop() {
	[[ "$(on_machine)" == 'linux_arch_io' ]]
}

precommit() {
	if on_laptop; then
		make lint && make || return $?
	fi
	true
}

precommit && git add -A && git --no-pager diff --staged && git commit -m "$commit_message" && git push && {
	if on_laptop; then
		# do a manual sync from this ./dist to remote, this prevents having to build again remotely
		make sync_to_server
	else
		# otherwise, if im on my phone or somewhere else, I can just push and let it build remotely
		make sync_personal_notes_to_server
		deploy exobrain
	fi
}
