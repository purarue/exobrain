---
import Base from "./Base.astro";
import { getCollection, type CollectionEntry } from "astro:content";
import url_for from "../helpers/url";
import PhotoCaption from "./PhotoCaption.astro";

type Post = CollectionEntry<"photography"> | CollectionEntry<"art">;

// update here if I ever add any more galleries that match this schema
type Props = {
	mediaType: "photography" | "art";
};

const { mediaType } = Astro.props;

const photos: Post[] = (await getCollection(mediaType)).sort((a, b) => {
	return a.data.date > b.data.date ? -1 : 1;
});

function capitalize(name: string | undefined): string {
	if (name === undefined) {
		throw new Error("name undefined");
	}
	return name.slice(0, 1).toUpperCase() + name.slice(1);
}
---

<Base
	title={capitalize(mediaType)}
	description=`my ${mediaType}`
	disableFooter={false}
	fullWidth={true}
>
	<style>
		* {
			margin: 0;
			padding: 0;
		}
		.gallery {
			display: flex;
			flex-flow: wrap;
			justify-content: center;
			align-items: center;
		}
		.gallery-item {
			flex-grow: 1;
			max-width: 480px;
		}
		.gallery-item:before {
			content: "";
			display: block;
			padding-top: 10%;
		}
		figure img {
			width: 90%;
			margin-left: auto;
			margin-right: auto;
		}
		.intro {
			text-align: center;
			margin-top: 2rem;
		}
	</style>
	<section>
		<div class="gallery">
			{
				photos.map((line) => {
					return (
						<figure class="gallery-item">
							<a
								href={url_for(`/${mediaType}/full/${line.data.image}`)}
								target="_blank"
							>
								<img
									width={line.data.thumbnail_width}
									height={line.data.thumbnail_height}
									src={url_for(`/${mediaType}/thumbs/${line.data.image}`)}
								/>
							</a>
							<PhotoCaption
								date={line.data.date}
								tags={line.data.tags}
								caption={line.data.caption}
							/>
						</figure>
					);
				})
			}
		</div>
	</section>
</Base>

<!-- bind custom photocaption data -->
<script type="module" is:inline>
	document.addEventListener("DOMContentLoaded", () => {
		// prevent weird issue in dev from it binding events on every hot module reload
		if (!window.__photo_tags_bound) {
			window.__photo_tags_bound = true;
			document.querySelectorAll(".photo-tag").forEach((el) => {
				el.addEventListener("click", () => {
					const tag = el.dataset.tag;
					const detail = el.dataset.detail;
					const showDetail = el.dataset.showDetail === "true";
					if (detail) {
						el.textContent = showDetail ? tag : detail;
						el.setAttribute("data-show-detail", showDetail ? "false" : "true");
					}
				});
			});
		}
	});
</script>
